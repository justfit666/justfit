{% extends "base.html" %}
{% load static %}
{% block content %}

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">

        <!-- PRODUCT IMAGE -->
        <div class="relative">
            <img id="variant-image"
                 src="{{ product.first_image_url }}"
                 class="w-full rounded-xl shadow-md object-cover max-h-[500px]">

            <!-- SPECIAL OFFER BADGE ‚Äî SHOW ONLY WHEN specialOffer EXISTS -->
            {% if product.specialOffer %}
            <div class="absolute top-3 right-3 bg-orange-500 text-white px-4 py-1 text-sm font-bold rounded-md animate-pulse">
                üéÅ {{ product.specialOffer }}
            </div>
            {% else %}

            <!-- NORMAL DISCOUNT BADGE ‚Äî SHOW ONLY IF NO SPECIAL OFFER -->
            {% if product.discount > 0 %}
            <div class="absolute top-3 left-3 bg-red-600 text-white px-3 py-1 text-xs font-bold rounded-md">
                SAVE {{ product.discount|floatformat:0 }}%
            </div>
            {% endif %}

            {% endif %}
        </div>

        <!-- PRODUCT INFO -->
        <div>
            <h1 class="text-3xl font-bold text-gray-900">{{ product.name }}</h1>

            <p class="text-gray-600 mt-3 leading-relaxed">
                {{ product.description }}
            </p>

            <!-- PRICE SECTION ‚Äî HIDDEN WHEN specialOffer EXISTS -->
            {% if not product.specialOffer %}
            <div class="mt-4">
                <p class="text-2xl font-semibold text-red-600">
                    {{ product.selling_price|floatformat:0 }} EGP

                    {% if product.discount > 0 %}
                    <span class="text-gray-400 line-through text-lg font-normal ml-2">
                        {{ product.original_price|floatformat:0 }} EGP
                    </span>
                    {% endif %}
                </p>
            </div>
            {% endif %}

            <!-- SIZES ‚Äî HIDDEN WHEN specialOffer EXISTS -->
            {% if sizes %}
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Select Size</h3>
                <div id="size-options" class="flex flex-wrap gap-2">
                    {% for s in sizes %}
                    <button
                        class="size-btn px-4 py-2 border rounded-md hover:bg-black hover:text-white transition"
                        data-size="{{ s }}">
                        {{ s }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- COLORS ‚Äî HIDDEN WHEN specialOffer EXISTS -->
            {% if colors  %}
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Select Color</h3>
                <div id="color-options" class="flex flex-wrap gap-2">
                    {% for c in colors %}
                    <button
                        class="color-btn px-4 py-2 border rounded-md hover:bg-gray-800 hover:text-white transition"
                        data-color="{{ c }}">
                        {{ c }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}


            <!-- ACTION BUTTON -->
            {% if product.specialOffer %}
                <!-- SPECIAL OFFER BUTTON ‚Äî BIG, ANIMATED -->
                <button 
                    class="messenger-btn w-full mt-8 bg-orange-500 text-white py-4 rounded-xl text-xl font-bold animate-bounce flex items-center justify-center gap-3"
                    data-product="{{ product.name }}"
                    data-size=""
                    data-color=""
                    data-qty="1">

                    <i class="fa-brands fa-facebook text-3xl"></i>
                    ÿßÿ≠ÿ¨ÿ≤ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑÿÆÿßÿµ ÿØŸÑŸàŸÇÿ™Ÿä üî•
                </button>

            {% else %}
                <!-- NORMAL BUTTON -->
                <button 
                    class="messenger-btn w-full mt-3 bg-blue-600 text-white py-3 rounded-lg text-lg font-medium hover:bg-blue-700 transition flex items-center justify-center gap-2"
                    data-product="{{ product.name }}"
                    data-size=""
                    data-color=""
                    data-qty="1">
                
                    <i class="fa-brands fa-facebook text-2xl"></i>
                    ÿßÿ≠ÿ¨ÿ≤ ÿØŸÑŸàŸÇÿ™Ÿä
                </button>


                <!-- <div class="mt-8"> <button class="w-full bg-black text-white py-3 rounded-lg text-lg font-medium hover:bg-gray-800 transition"> Add to Cart üõí </button> </div> -->
            {% endif %}

        </div>
    </div>
</div>



<!-- JS -->
<script>
let selectedSize = null;
let selectedColor = null;

function updateVariant() {
    const url = `/api/product/{{ product.id }}/filter/?size=${selectedSize || ""}&color=${selectedColor || ""}`;

    fetch(url)
        .then(res => res.json())
        .then(data => {

            document.querySelectorAll(".size-btn").forEach(btn => {
                const val = btn.dataset.size;
                btn.disabled = !data.sizes.includes(val);
                btn.classList.toggle("bg-black", val === selectedSize);
                btn.classList.toggle("text-white", val === selectedSize);
            });

            document.querySelectorAll(".color-btn").forEach(btn => {
                const val = btn.dataset.color;
                btn.disabled = !data.colors.includes(val);
                btn.classList.toggle("bg-gray-800", val === selectedColor);
                btn.classList.toggle("text-white", val === selectedColor);
            });

            if (data.image) document.getElementById("variant-image").src = data.image;
        });
}

document.querySelectorAll(".size-btn").forEach(btn => {
    btn.addEventListener("click", function () {
        const clicked = this.dataset.size;
        selectedSize = (selectedSize === clicked ? null : clicked);
        updateVariant();
    });
});

document.querySelectorAll(".color-btn").forEach(btn => {
    btn.addEventListener("click", function () {
        const clicked = this.dataset.color;
        selectedColor = (selectedColor === clicked ? null : clicked);
        updateVariant();
    });
});

document.querySelectorAll(".messenger-btn").forEach(btn => {
    btn.addEventListener("click", function() {

        let product = this.dataset.product;
        let size = this.dataset.size || "Not selected";
        let color = this.dataset.color || "Not selected";
        let qty = this.dataset.qty;

        let message =
`Hello, I am interested in this product:
Product: ${product}
Size: ${size}
Color: ${color}
Quantity: ${qty}`;

        navigator.clipboard.writeText(message)
            .then(() => alert("Message copied ‚úî\nPaste it in FB chat"));

        let pageId = "61582294003145";
        window.open(`https://www.facebook.com/messages/t/${pageId}`, "_blank");
    });
});
</script>

{% endblock %}
