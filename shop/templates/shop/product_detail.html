{% extends "base.html" %}
{% load static %}
{% block content %}

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">

        <!-- PRODUCT IMAGE -->
        <div class="relative">
            <img id="variant-image"
                 src="{{ product.first_image_url }}"
                 class="w-full rounded-xl shadow-md object-cover max-h-[500px]">

            {% if product.specialOffer %}
            <div class="absolute top-3 right-3 bg-orange-500 text-white px-4 py-1 text-sm font-bold rounded-md animate-pulse">
                üéÅ {{ product.specialOffer }}
            </div>
            {% else %}
                {% if product.discount > 0 %}
                <div class="absolute top-3 left-3 bg-red-600 text-white px-3 py-1 text-xs font-bold rounded-md">
                    SAVE {{ product.discount|floatformat:0 }}%
                </div>
                {% endif %}
            {% endif %}
        </div>

        <!-- PRODUCT INFO -->
        <div>
            <h1 class="text-3xl font-bold text-gray-900">{{ product.name }}</h1>

            <p class="text-gray-600 mt-3 leading-relaxed">
                {{ product.description }}
            </p>

            {% if not product.specialOffer %}
            <div class="mt-4">
                <p class="text-2xl font-semibold text-red-600">
                    {{ product.selling_price|floatformat:0 }} EGP
                    {% if product.discount > 0 %}
                    <span class="text-gray-400 line-through text-lg ml-2">
                        {{ product.original_price|floatformat:0 }} EGP
                    </span>
                    {% endif %}
                </p>
            </div>
            {% endif %}

            <!-- SIZES -->
            {% if sizes %}
            <div class="mt-6">
                <h3 class="text-lg font-semibold mb-2">Select Size</h3>
                <div class="flex gap-2 flex-wrap">
                    {% for s in sizes %}
                    <button
                        class="size-btn px-4 py-2 border rounded-md transition"
                        data-size="{{ s }}">
                        {{ s }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- COLORS -->
            {% if colors %}
            <div class="mt-6">
                <h3 class="text-lg font-semibold mb-2">Select Color</h3>
                <div class="flex gap-2 flex-wrap">
                    {% for c in colors %}
                    <button
                        class="color-btn px-4 py-2 border rounded-md transition"
                        data-color="{{ c }}">
                        {{ c }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- BUTTON -->
            <button
                class="messenger-btn w-full mt-8 bg-blue-600 text-white py-3 rounded-lg text-lg flex items-center justify-center gap-2 hover:bg-blue-700 transition"
                data-product="{{ product.name }}"
                data-size=""
                data-color=""
                data-qty="1">

                <i class="fa-brands fa-facebook text-2xl"></i>
                ÿßÿ≠ÿ¨ÿ≤ ÿØŸÑŸàŸÇÿ™Ÿä
            </button>
        </div>
    </div>
</div>

<!-- JS -->
<script>
    let selectedSize = null;
    let selectedColor = null;
    
    function updateVariant() {
        const url = `/api/product/{{ product.id }}/filter/?size=${selectedSize || ""}&color=${selectedColor || ""}`;
    
        fetch(url)
            .then(res => res.json())
            .then(data => {
    
                /* ---------- SIZES ---------- */
                document.querySelectorAll(".size-btn").forEach(btn => {
                    const size = btn.dataset.size;
    
                    btn.disabled = false;
                    btn.classList.remove("bg-black", "text-white", "opacity-40", "cursor-not-allowed");
    
                    // Disable sizes ONLY if color selected
                    if (selectedColor && !data.sizes.includes(size)) {
                        btn.disabled = true;
                        btn.classList.add("opacity-40", "cursor-not-allowed");
                    }
    
                    if (size === selectedSize) {
                        btn.classList.add("bg-black", "text-white");
                    }
                });
    
                /* ---------- COLORS ---------- */
                document.querySelectorAll(".color-btn").forEach(btn => {
                    const color = btn.dataset.color;
    
                    btn.disabled = false;
                    btn.classList.remove("bg-gray-800", "text-white", "opacity-40", "cursor-not-allowed");
    
                    // Disable colors ONLY if size selected
                    if (selectedSize && !data.colors.includes(color)) {
                        btn.disabled = true;
                        btn.classList.add("opacity-40", "cursor-not-allowed");
                    }
    
                    if (color === selectedColor) {
                        btn.classList.add("bg-gray-800", "text-white");
                    }
                });
    
                /* ---------- IMAGE ---------- */
                if (data.image) {
                    document.getElementById("variant-image").src = data.image;
                }
    
                /* ---------- CTA DATA ---------- */
                document.querySelectorAll(".messenger-btn").forEach(btn => {
                    btn.dataset.size = selectedSize || "";
                    btn.dataset.color = selectedColor || "";
                });
            });
    }
    
    /* ---------- SIZE CLICK ---------- */
    document.querySelectorAll(".size-btn").forEach(btn => {
        btn.addEventListener("click", function () {
            const clicked = this.dataset.size;
    
            // Toggle logic
            selectedSize = (selectedSize === clicked) ? null : clicked;
    
            updateVariant();
        });
    });
    
    /* ---------- COLOR CLICK ---------- */
    document.querySelectorAll(".color-btn").forEach(btn => {
        btn.addEventListener("click", function () {
            if (this.disabled) return;
    
            const clicked = this.dataset.color;
    
            // Toggle logic
            selectedColor = (selectedColor === clicked) ? null : clicked;
    
            updateVariant();
        });
    });
    </script>
    

{% endblock %}
