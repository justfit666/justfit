{% extends "base.html" %}
{% load static %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<div class="container my-5">
    <h2 class="mb-4 text-center">ðŸ“¦ Product Management</h2>

<!-- ðŸ” Search + Filter + Sort Bar -->
<form method="GET" class="row g-3 mb-4">

    <!-- Search Box -->
    <div class="col-md-4">
        <input type="text" name="search" value="{{ search }}"
               placeholder="Search product..." class="form-control">
    </div>

    <!-- Category Filter -->
    <div class="col-md-3">
        <select name="category" class="form-select">
            <option value="">All Categories</option>
            {% for c in categories %}
            <option value="{{ c.id }}" {% if selected_category == c.id|stringformat:'s' %}selected{% endif %}>
                {{ c.name }}
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- Sorting -->
    <div class="col-md-3">
        <select name="sort" class="form-select">
            <option value="">Sort By</option>
            <option value="name_az"  {% if sort == 'name_az' %}selected{% endif %}>Name A â†’ Z</option>
            <option value="name_za"  {% if sort == 'name_za' %}selected{% endif %}>Name Z â†’ A</option>
            <option value="qty_high" {% if sort == 'qty_high' %}selected{% endif %}>Quantity High â†’ Low</option>
            <option value="qty_low"  {% if sort == 'qty_low' %}selected{% endif %}>Quantity Low â†’ High</option>
        </select>
    </div>
<!-- Color Filter -->
<div class="col-md-3">
    <label class="fw-bold">Colors</label>

    <div class="dropdown w-100">
        <button class="btn btn-outline-primary dropdown-toggle w-100" type="button"
                data-bs-toggle="dropdown" aria-expanded="false">
            {% if selected_colors %}
                {{ selected_colors|join:", " }}
            {% else %}
                Select Colors
            {% endif %}
        </button>

        <ul class="dropdown-menu p-2" style="max-height:250px; overflow-y:auto;">
            {% for c in colors %}
                <li>
                    <label class="dropdown-item">
                        <input type="checkbox" name="color"
                               value="{{ c }}"
                               {% if c in selected_colors %}checked{% endif %}>
                        {{ c }}
                    </label>
                </li>
            {% endfor %}
        </ul>
    </div>
</div>



<!-- Size Filter -->
<div class="col-md-3">
    <label class="fw-bold">Sizes</label>

    <div class="dropdown w-100">
        <button class="btn btn-outline-primary dropdown-toggle w-100" type="button"
                data-bs-toggle="dropdown" aria-expanded="false">
            {% if selected_sizes %}
                {{ selected_sizes|join:", " }}
            {% else %}
                Select Sizes
            {% endif %}
        </button>

        <ul class="dropdown-menu p-2" style="max-height:250px; overflow-y:auto;">
            {% for s in sizes %}
                <li>
                    <label class="dropdown-item">
                        <input type="checkbox" name="size"
                               value="{{ s }}"
                               {% if s in selected_sizes %}checked{% endif %}>
                        {{ s }}
                    </label>
                </li>
            {% endfor %}
        </ul>
    </div>
</div>


<div class="col-md-2">
    <label class="fw-bold">Availability</label>
    <select name="availability" class="form-select">
        <option value="">All</option>
        <option value="in_stock" {% if availability == "in_stock" %}selected{% endif %}>In Stock</option>
        <option value="out_of_stock" {% if availability == "out_of_stock" %}selected{% endif %}>Out of Stock</option>
    </select>
</div>

    <!-- Submit Button -->
    <div class="col-md-2">
        <button class="btn btn-dark w-100">Apply</button>
    </div>

</form>



    <table class="table table-hover table-bordered align-middle">
        <thead class="table-dark text-center">
            <tr>
                <th>Image</th>
                <th>Name</th>
                <th>Category</th>
                <th>Purchase Price</th> <!-- NEW -->
                <th>Selling Price</th> <!-- NEW -->
                <th>Total Qty</th>
                <th>Total availabile</th>
                <th>Variants</th>
            </tr>
        </thead>
        <tbody>
            {% for p in products %}
            <tr>
                <td>
                    {% if p.first_image_url %}
                    <img src="{{ p.first_image_url }}" alt="{{ p.name }}" width="50" height="50">
                    {% endif %}
                </td>
                <td>{{ p.name }}</td>
                <td>{{ p.category }}</td>
                <td>{{ p.purchase_price }}</td> <!-- NEW -->
                <td>{{ p.selling_price }}</td> <!-- NEW -->
                <td>{{ p.total_quantity }}</td>
                <td>{{ p.total_quantity_available }}</td> 
                <td>
                    <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#variants-{{ p.id }}">
                        View Variants ({{ p.variants.count }})
                    </button>
                </td>
            </tr>
            <tr class="collapse" id="variants-{{ p.id }}">
                <td colspan="6">
                    <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light text-center">
                            <tr>
                                <th>Size</th>
                                <th>Color</th>
                                <th>Quantity</th>
                                <th>Availabile</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for v in p.variants.all %}
                            <tr class="text-center">
                                <td>{{ v.size }}</td>
                                <td>{{ v.color }}</td>
                                <td>
                                    <input type="number" class="form-control variant-field" value="{{ v.quantity }}" data-variant-id="{{ v.id }}" data-field="quantity" disabled="true">
                                </td>
                                <td>
                                    <input type="number" class="form-control variant-field" value="{{ v.availability_count }}" data-variant-id="{{ v.id }}" data-field="availability_count">
                                </td>
                                <td>
                                    <button class="btn btn-success btn-sm save-variant">ðŸ’¾ Save</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    /* Helper: get CSRF token from cookie (works in most Django setups) */
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    /* Show a small alert element next to the save button */
    function showInlineAlert(container, message, type='success', timeout=4000) {
        // container: a DOM element (e.g. td or tr) where we'll append the alert
        const existing = container.querySelector('.inline-alert');
        if (existing) existing.remove();
    
        const div = document.createElement('div');
        div.className = `inline-alert alert alert-${type} mt-2 py-1 px-2`;
        div.style.display = 'inline-block';
        div.style.marginLeft = '8px';
        div.style.fontSize = '0.9rem';
        div.textContent = message;
        container.appendChild(div);
    
        if (timeout) {
            setTimeout(()=> {
                div.remove();
            }, timeout);
        }
    }
    
    /* Handler for Save buttons */
    document.querySelectorAll(".save-variant").forEach(btn => {
        btn.addEventListener("click", async (e) => {
            const row = btn.closest("tr");
            const qtyInput = row.querySelector('input[data-field="quantity"]');
            const qtyOutInput = row.querySelector('input[data-field="availability_count"]');
    
            // If page structure different, try to find inputs in same row
            if (!qtyInput || !qtyOutInput) {
                showInlineAlert(row, "Inputs not found", "danger");
                return;
            }
    
            const variantId = qtyInput.dataset.variantId;
            if (!variantId) {
                showInlineAlert(row, "Variant ID missing", "danger");
                return;
            }
    
            const qty = qtyInput.value;
            const qtyOut = qtyOutInput.value;
    
            if (!confirm("Are you sure you want to save this variant's quantities?")) return;
    
            // Disable button while processing
            btn.disabled = true;
            btn.innerText = "Saving...";
    
            try {
                // Update quantity
                let body = new URLSearchParams();
                body.append('field', 'quantity');
                body.append('value', qty);
    
                let resp = await fetch(`/products/update-variant/${variantId}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    body: body
                });
                const json1 = await resp.json();
    
                if (!json1.success) {
                    showInlineAlert(row, json1.message || "Failed to update quantity", "danger");
                    btn.disabled = false;
                    btn.innerText = "ðŸ’¾ Save";
                    return;
                }
    
                // Update availability_count
                body = new URLSearchParams();
                body.append('field', 'availability_count');
                body.append('value', qtyOut);
    
                resp = await fetch(`/products/update-variant/${variantId}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    body: body
                });
                const json2 = await resp.json();
    
                if (!json2.success) {
                    showInlineAlert(row, json2.message || "Failed to update availability_count", "danger");
                    btn.disabled = false;
                    btn.innerText = "ðŸ’¾ Save";
                    return;
                }
    
                // Success
                showInlineAlert(row, "Saved", "success");
                btn.disabled = false;
                btn.innerText = "ðŸ’¾ Save";
    
                // Optionally update product totals in the UI (reload row or page, or update text nodes).
                // e.g. you could fetch product totals and replace cells here. For simplicity we don't do that automatically.
            } catch (err) {
                console.error(err);
                showInlineAlert(row, "Network or server error", "danger");
                btn.disabled = false;
                btn.innerText = "ðŸ’¾ Save";
            }
        });
    });
    </script>
    
{% endblock %}
